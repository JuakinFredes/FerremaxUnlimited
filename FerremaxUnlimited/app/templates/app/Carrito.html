{% extends 'app/base.html' %}
{% load static %}

<!--este bloque es para los css especificos de pagina-->
{% block css %}
<link rel="stylesheet" href="{% static 'css/carrito.css' %}">
{% endblock %}

<!--este bloque es para los javascript especificos de pagina-->
{% block js %}
<script>


    function changeQty(id, delta) {
        const input = document.getElementById(id);
        let val = parseInt(input.value) || 1;
        val += delta;
        if (val < 1) val = 1;
        input.value = val;
        sendUpdate(id);
    }

    function sendUpdate(inputId) {
        const input = document.getElementById(inputId);
        const cantidad = parseInt(input.value);
        const productoId = input.dataset.productoId;

        fetch("{% url 'actualizar_cantidad_carro' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                producto_id: productoId,
                cantidad: cantidad
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.subtotal !== undefined) {
                const subtotalElem = document.getElementById('total' + inputId.replace('qty', ''));
                subtotalElem.textContent = `$${data.subtotal.toFixed(2)}`;
                document.getElementById('grandTotal').textContent = data.total.toFixed(2);
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(err => {
            console.error("Error en actualización:", err);
        });
    }
</script>

{% endblock %}



{% block contenido %}

<div class="container py-5">
    <h2 class="mb-4">Tu Carrito</h2>

    {% if carrito %}
        {% for item in carrito %}
        <div class="row align-items-center cart-item shadow mb-4 rounded">
            <div class="col-md-2">
                <img src="{{ item.productos.imagen.url }}" alt="{{ item.productos.nombre }}" class="img-fluid">
            </div>
            <div class="col-md-2">
                <h5>{{ item.productos.nombre }}</h5>
                <p class="mb-0 text-muted">Precio unitario: ${{ item.productos.precio }}</p>
            </div>
            <div class="col-md-2">
                <div class="input-group" style="max-width: 120px;">
                    <button class="btn btn-outline-secondary" type="button" onclick="changeQty('qty{{ forloop.counter }}', -1)">−</button>
                    <input type="number" class="form-control text-center"
                        id="qty{{ forloop.counter }}"
                        data-producto-id="{{ item.productos.id }}"
                        value="{{ item.cantidad }}" min="1" max="99"
                        onchange="sendUpdate('qty{{ forloop.counter }}')">
                    <button class="btn btn-outline-secondary" type="button" onclick="changeQty('qty{{ forloop.counter }}', 1)">+</button>
                </div>
            </div>
            <div class="col-md-2">
                <p class="fw-bold mb-0" id="total{{ forloop.counter }}">${{ item.productos.precio|floatformat:2 }}</p>
            </div>
            <div class="col-md-2">
                <form action="{% url 'eliminarCarro' item.productos.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger">Eliminar</button>
                </form>
            </div>
        </div>
        {% endfor %}

        <!-- Total final -->
        <div class="row justify-content-end mt-4">
            <div class="col-md-4 text-end">
                <h4>Total: $<span id="grandTotal">{{ total }}</span></h4>
                <button class="btn btn-success">Finalizar Compra</button>
            </div>
        </div>
    {% else %}
        <p>No tienes productos en tu carrito.</p>
    {% endif %}
</div>


{% endblock %}